name: Deploy Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'firmware/src/**'        # C source changes (for Doxygen)
      - 'firmware/include/**'    # Header changes (for Doxygen)
      - 'docs/**'                # Documentation changes (Jekyll markdown, images, config)
      - 'Doxyfile'               # Doxygen configuration changes
      - '.github/workflows/deploy-docs.yml'  # Workflow changes
  workflow_dispatch:  # Allow manual trigger for testing

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-docs:
    name: Generate and Deploy Doxygen Documentation
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Doxygen and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Verify Graphviz installation
        run: |
          echo "ğŸ” Verifying Graphviz installation..."
          which dot
          dot -V
          echo "âœ… Graphviz (dot) is installed and accessible"

      - name: Generate Doxygen documentation
        run: |
          doxygen Doxyfile 2>&1 | tee doxygen.log
          echo ""
          echo "âœ… Doxygen documentation generated at docs/api/html/"
          echo ""

          # Check for any dot-related warnings or errors
          if grep -i "warning.*dot" doxygen.log; then
            echo "âš ï¸  Warning: Found dot-related warnings in Doxygen output"
          fi
          if grep -i "error.*dot" doxygen.log; then
            echo "âŒ Error: Found dot-related errors in Doxygen output"
            exit 1
          fi

          # Verify SVG files were generated
          echo "ğŸ” Checking for generated SVG call graphs..."
          SVG_COUNT=$(find docs/api/html -name "*.svg" -type f | wc -l)
          echo "Found $SVG_COUNT SVG files"
          if [ $SVG_COUNT -gt 0 ]; then
            echo "âœ… SVG graph files generated successfully"
            echo "Sample SVG files:"
            find docs/api/html -name "*call*.svg" -o -name "*caller*.svg" | head -5
          else
            echo "âš ï¸  Warning: No SVG files found - graphs may not be generated"
          fi

          echo ""
          ls -la docs/api/html/ | head -20

      - name: Add .nojekyll to Doxygen output
        run: |
          # Prevent Jekyll from processing Doxygen HTML files
          # This is critical for files with underscores (e.g., _r_e_a_d_m_e_8md.html)
          touch docs/api/html/.nojekyll
          echo "âœ… Created .nojekyll file in docs/api/html/"

      - name: Validate documentation structure
        run: |
          echo "ğŸ“‹ Validating documentation files exist..."
          echo ""

          # Check Jekyll source files
          echo "1ï¸âƒ£ Checking Jekyll markdown files..."
          test -f docs/index.md && echo "âœ… docs/index.md exists" || (echo "âŒ docs/index.md MISSING" && exit 1)
          test -f docs/build.md && echo "âœ… docs/build.md exists" || (echo "âŒ docs/build.md MISSING" && exit 1)
          test -f docs/architecture.md && echo "âœ… docs/architecture.md exists" || (echo "âŒ docs/architecture.md MISSING" && exit 1)
          test -f docs/_config.yml && echo "âœ… docs/_config.yml exists" || (echo "âŒ docs/_config.yml MISSING" && exit 1)
          echo ""

          # Check Doxygen output
          echo "2ï¸âƒ£ Checking Doxygen HTML files..."
          test -f docs/api/html/index.html && echo "âœ… docs/api/html/index.html exists" || (echo "âŒ docs/api/html/index.html MISSING" && exit 1)
          test -f docs/api/html/.nojekyll && echo "âœ… docs/api/html/.nojekyll exists" || (echo "âŒ docs/api/html/.nojekyll MISSING" && exit 1)
          echo ""

          # Check images
          echo "3ï¸âƒ£ Checking image assets..."
          test -f docs/images/step_response_example.png && echo "âœ… docs/images/step_response_example.png exists" || echo "âš ï¸  docs/images/step_response_example.png missing"
          echo ""

          # Verify Doxygen generated files with underscores
          echo "4ï¸âƒ£ Checking for Doxygen files with underscores..."
          if ls docs/api/html/_*.html 1> /dev/null 2>&1; then
            echo "âœ… Found Doxygen files with underscores (will be protected by .nojekyll)"
            ls docs/api/html/_*.html | head -5
          else
            echo "âš ï¸  No underscore files found (unusual for Doxygen)"
          fi
          echo ""

          # Validate links in index.md
          echo "5ï¸âƒ£ Validating internal links in docs/index.md..."
          ERRORS=0

          # Check if linked files exist (after Jekyll processing they'll become .html)
          grep -o 'href="[^"]*"' docs/index.md | sed 's/href="//;s/"//' | while read -r link; do
            # Skip external links
            if [[ "$link" =~ ^https?:// ]]; then
              continue
            fi

            # Convert expected Jekyll output to source file
            case "$link" in
              "build.html")
                if [ ! -f "docs/build.md" ]; then
                  echo "âŒ Link target build.html (from build.md) - source file missing"
                  ERRORS=$((ERRORS + 1))
                else
                  echo "âœ… Link build.html â†’ docs/build.md exists"
                fi
                ;;
              "architecture.html")
                if [ ! -f "docs/architecture.md" ]; then
                  echo "âŒ Link target architecture.html (from architecture.md) - source file missing"
                  ERRORS=$((ERRORS + 1))
                else
                  echo "âœ… Link architecture.html â†’ docs/architecture.md exists"
                fi
                ;;
              "api/html/index.html")
                if [ ! -f "docs/api/html/index.html" ]; then
                  echo "âŒ Link target api/html/index.html - file missing"
                  ERRORS=$((ERRORS + 1))
                else
                  echo "âœ… Link api/html/index.html â†’ docs/api/html/index.html exists"
                fi
                ;;
            esac
          done
          echo ""

          # Check _config.yml doesn't exclude api/
          echo "6ï¸âƒ£ Checking Jekyll configuration..."
          if grep -q "exclude:.*api/" docs/_config.yml; then
            echo "âŒ CRITICAL: _config.yml excludes api/ folder - Doxygen won't be deployed!"
            exit 1
          else
            echo "âœ… _config.yml does not exclude api/ folder"
          fi
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Documentation Structure Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "docs/"
          echo "â”œâ”€â”€ _config.yml              (Jekyll config - Cayman theme)"
          echo "â”œâ”€â”€ index.md                 (Landing page â†’ index.html)"
          echo "â”œâ”€â”€ build.md                 (Build guide â†’ build.html)"
          echo "â”œâ”€â”€ architecture.md          (Architecture â†’ architecture.html)"
          echo "â”œâ”€â”€ images/"
          echo "â”‚   â””â”€â”€ step_response_example.png"
          echo "â””â”€â”€ api/"
          echo "    â””â”€â”€ html/"
          echo "        â”œâ”€â”€ .nojekyll        (Protects underscore files)"
          echo "        â”œâ”€â”€ index.html       (Doxygen main page)"
          echo "        â””â”€â”€ [100+ Doxygen files]"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Expected URLs After Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Base: https://onesmoogore.github.io/embedded-motor-pid-controller/"
          echo ""
          echo "Jekyll Pages (processed from .md):"
          echo "  âœ“ /                              (from index.md)"
          echo "  âœ“ /build.html                    (from build.md)"
          echo "  âœ“ /architecture.html             (from architecture.md)"
          echo ""
          echo "Static Files (copied as-is):"
          echo "  âœ“ /api/html/index.html           (Doxygen main)"
          echo "  âœ“ /api/html/_*.html              (Protected by .nojekyll)"
          echo "  âœ“ /images/step_response_example.png"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload documentation artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload entire docs folder - Jekyll will process .md files, leave api/html/ as-is
          path: './docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“š Documentation Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Main Site: https://onesmoogore.github.io/embedded-motor-pid-controller/"
          echo ""
          echo "ğŸ“– Documentation Pages:"
          echo "  â”œâ”€ Landing Page:    https://onesmoogore.github.io/embedded-motor-pid-controller/"
          echo "  â”œâ”€ Build Guide:     https://onesmoogore.github.io/embedded-motor-pid-controller/build.html"
          echo "  â”œâ”€ Architecture:    https://onesmoogore.github.io/embedded-motor-pid-controller/architecture.html"
          echo "  â””â”€ API Reference:   https://onesmoogore.github.io/embedded-motor-pid-controller/api/html/index.html"
          echo ""
          echo "ğŸ–¼ï¸  Assets:"
          echo "  â””â”€ Images:          https://onesmoogore.github.io/embedded-motor-pid-controller/images/"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Validation Steps:"
          echo "  1. Visit the main site and verify Jekyll theme is applied"
          echo "  2. Click 'Build Instructions' link â†’ should load build.html"
          echo "  3. Click 'Architecture' link â†’ should load architecture.html"
          echo "  4. Click 'API Reference' link â†’ should load api/html/index.html"
          echo "  5. Verify images load correctly"
          echo "  6. Test Doxygen navigation (files with underscores should work)"
          echo ""
          echo "Page URL: ${{ steps.deployment.outputs.page_url }}"
